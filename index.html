<!DOCTYPE html>
<html>
<head>
<title>Myanmar Energy Accesibiility</title>
<link rel="stylesheet" href="style.css" type="text/css" media="screen" />
<style type='text/css'>
.background {
    fill: #eee;
    pointer-events: all;
}

.map-layer {
    fill: #fff;
    stroke: #aaa;
}

.road-layer {
    fill-opacity: 0;
    stroke: #C21F1F;
    stroke-opacity: 0.5;
}

.hv-layer {
    fill-opacity: 0;
    stroke: #35B635;
    stroke-opacity: 0.5;
}

.mv-layer {
    fill-opacity: 0;
    stroke: #385598;
    stroke-opacity: 0.5;
}

text {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 300;
}

text.big-text {
    font-size: 30px;
    font-weight: 400;
}

svg {
    position: absolute;
    left: 0px;
    top: 0px;
}

.button {
    fill: #000;
    color: #fff;
}

.roads {
    z-index: 10000000;
}
</style>
</head>
<body>
<div id="main-wrapper">
<svg></svg>

<div id="tooltip" class="tooltip">
    <h3 class="name"></h3>
    <div data-metric="HC01_EST_VC04" class="line">
        <div class="HC01_EST_VC04 symbol"></div> Electricity
        <div class="HC01_EST_VC04_val moe"></div>
        <div class="HC01_EST_VC04_val val"></div>
    </div>
    <div data-metric="HC01_EST_VC05" class="line">
        <div class="HC01_EST_VC05 symbol"></div> Kerosene
        <div class="HC01_EST_VC05_val moe"></div>
        <div class="HC01_EST_VC05_val val"></div>
    </div>
    <div data-metric="HC01_EST_VC10" class="line">
        <div class="HC01_EST_VC10 symbol"></div> Candle
        <div class="HC01_EST_VC10_val moe"></div>
        <div class="HC01_EST_VC10_val val"></div>
    </div>
    <div data-metric="HC01_EST_VC11" class="line">
        <div class="HC01_EST_VC11 symbol"></div> Battery
        <div class="HC01_EST_VC11_val moe"></div>
        <div class="HC01_EST_VC11_val val"></div>
    </div>
    <div data-metric="HC01_EST_VC12" class="line">
        <div class="HC01_EST_VC12 symbol"></div> Private Generator
        <div class="HC01_EST_VC12_val moe"></div>
        <div class="HC01_EST_VC12_val val"></div>
    </div>
    <div data-metric="HC01_EST_VC13" class="line">
        <div class="HC01_EST_VC13 symbol"></div> Private Water Mill
        <div class="HC01_EST_VC13_val moe"></div>
        <div class="HC01_EST_VC13_val val"></div>
    </div>
    <div data-metric="HC01_EST_VC14" class="line">
        <div class="HC01_EST_VC14 symbol"></div> Solar and Other
        <div class="HC01_EST_VC14_val moe"></div>
        <div class="HC01_EST_VC14_val val"></div>
    </div>
</div>

</div><!-- @end #main-wrapper -->

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 1200,
    height = 1200,
    centered;

var color = d3.scale.linear()
    .domain([1, 100])
    .clamp(true)
    .range(['#fff', '#409A99']);

var projection = d3.geo.mercator()
    .scale(3000)
    .center([96.7, 19.1])
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 100])
    .on('zoom', zoomed);

var svg = d3.select('svg')
    .attr('width', width)
    .attr('height', height);

var g = svg.append('g');

svg.call(zoom)
    .call(zoom.event);

var mapLayer = g.append('g')
    .classed('map-layer', true);

var roadLayer = g.append('g')
    .classed('road-layer', true);

var hvLayer = g.append('g')
    .classed('hv-layer', true);

var mvLayer = g.append('g')
    .classed('mv-layer', true);

var bigText = g.append('text')
    .classed('big-text', true)
    .attr('x', 100)
    .attr('y', 100);

d3.json('data/ts_2.geojson', function(error, mapData) {
    var tooltip = d3.select("#tooltip")
     .attr("class", "tooltip")
     .style("opacity", 0);

    var mapFeatures = mapData.features;

    color.domain([0, d3.max(mapFeatures, popFn)]);

    mapLayer.selectAll('path')
        .data(mapFeatures)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('vector-effect', 'non-scaling-stroke')
        .style('fill', fillFn)
        .on("mouseover", function(d) {
             d3.select(this).classed("selected", true);
             tooltip.transition().duration(100)
               .style("opacity", 1)
             if (d3.event.pageX > (width - 200)) {
                 tooltip.style("left", (d3.event.pageX - 210) + "px");
             } else {
                 tooltip.style("left", (d3.event.pageX + 20) + "px")
                      .style("top", (d3.event.pageY -30) + "px");
             }
             if (d3.event.pageY > (height - 150)) {
                 tooltip.style("top", (d3.event.pageY -140) + "px");
             } else {
                 tooltip.style("top", (d3.event.pageY -30) + "px");
             }

             tooltip.select(".name").text(d.properties.TS + " - Pop: " + d.properties.Total);

             tooltip.select(".HC01_EST_VC04_val.val").text((d.properties.Prop_Electricity*100).toFixed(1) + "%")
             tooltip.select(".HC01_EST_VC05_val.val").text((d.properties.Prop_Kerosene*100).toFixed(1) + "%")
             tooltip.select(".HC01_EST_VC10_val.val").text((d.properties.Prop_Candle*100).toFixed(1) + "%")
             tooltip.select(".HC01_EST_VC11_val.val").text((d.properties.Prop_Battery*100).toFixed(1) + "%")
             tooltip.select(".HC01_EST_VC12_val.val").text((d.properties.Prop_Generator_Private*100).toFixed(1) + "%")
             tooltip.select(".HC01_EST_VC13_val.val").text((d.properties.Prop_Water_Mill_Private*100).toFixed(1) + "%")
             tooltip.select(".HC01_EST_VC14_val.val").text(((d.properties.Prop_Solar_System_Energy + d.properties.Prop_Other)*100).toFixed(1) + "%")
           })
        .on("mouseout", function() {
            d3.select(this).classed("selected", false);
            tooltip.transition().duration(300)
              .style("opacity", 0);
            });


});

var roads_button = g.append('text')
    .text('Roads')
    .style({'font-size': 12, 'text-transform': 'uppercase'})
    .attr('x', 100)
    .attr('y', 100)
    .on('click', function() {
        var visibility = roadLayer.attr('visibility') == 'hidden' ? 'visible' : 'hidden';
        roadLayer.attr('visibility', visibility);
    });

var lines_button = g.append('text')
    .text('Lines')
    .style({'font-size': 12, 'text-transform': 'uppercase'})
    .attr('x', 100)
    .attr('y', 150)
    .on('click', function() {
        var visibility = mvLayer.attr('visibility') == 'hidden' ? 'visible' : 'hidden';
        mvLayer.attr('visibility', visibility);
        hvLayer.attr('visibility', visibility);
    });

d3.json('data/roads.geojson', function(error, roadData) {
    var roadFeatures = roadData.features;

    roadLayer.selectAll('path')
        .data(roadFeatures)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('vector-effect', 'non-scaling-stroke');
});

d3.json('data/high_voltage.geojson', function(error, hvData) {
    var hvFeatures = hvData.features;

    hvLayer.selectAll('path')
        .data(hvFeatures)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('vector-effect', 'non-scaling-stroke');
});

d3.json('data/medium_voltage.geojson', function(error, mvData) {
    var mvFeatures = mvData.features;

    mvLayer.selectAll('path')
        .data(mvFeatures)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('vector-effect', 'non-scaling-stroke');
});

function mouseover(d) {
    textArt(nameFn(d));
};

function mouseout(d) {
    d3.select(this).classed("selected", false);
    tooltip.transition().duration(300)
        .style("opacity", 0);
};

function textArt(text) {
    bigText.text(text);
};

function nameFn(d) {
    return d && d.properties ? d.properties.TS : null;
};

function popFn(d) {
    return d && d.properties ? d.properties.Total : 0;
};

function fillFn(d) {
    return color(popFn(d));
};

function zoomed() {
    g.attr("transform",
        "translate(" + zoom.translate() + ")" + "scale(" + zoom.scale() + ")");
};

function zoomClick() {
    var clicked = d3.event.target,
        direction = 1,
        factor = 0.2,
        target_zoom = 1,
        center = [width / 2, height / 2],
        extent = zoom.scaleExtent(),
        translate = zoom.translate(),
        translate0 = [],
        l = [],
        view = {x: translate[0], y: translate[1], k: zoom.scale()};

    d3.event.preventDefault();
    direction = (this.id === 'zoom_in') ? 1 : -1;
    target_zoom = zoom.scale() * (1 + factor * direction);

    if (target_zoom < extent[0] || target_zoom > extent[1]) { return false; }

    translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
    view.k = target_zoom;
    l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

    view.x += center[0] - l[0];
    view.y += center[1] - l[1];

    interpolateZoom([view.x, view.y], view.k);
};

function interpolateZoom (translate, scale) {
    var self = this;
    return
        d3.transition()
            .duration(350)
            .tween("zoom", function () {
                var iTranslate = d3.interpolate(zoom.translate(), translate),
                    iScale = d3.interpolate(zoom.scale(), scale);

                return function (t) {
                    zoom.scale(iScale(t))
                        .translate(iTranslate(t));
                    zoomed();
                };
            });
};


</script>
</body>
</html>
